---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Token Help - 8xM">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold mb-2">Token Help & Troubleshooting</h1>
    <p class="text-gray-400 mb-8">Can't see your tokens? Here's how to find and add them to your wallet.</p>

    <!-- Token Lookup Tool -->
    <div class="card mb-8">
      <h2 class="text-xl font-bold mb-4">Check Your Token Balance</h2>
      <p class="text-gray-400 text-sm mb-4">
        Enter your wallet address and token mint to check your balance on-chain.
      </p>

      <div class="space-y-4">
        <div>
          <label class="block text-sm text-gray-400 mb-1">Your Wallet Address</label>
          <input
            type="text"
            id="walletAddress"
            class="input w-full"
            placeholder="Your Solana wallet address..."
          />
        </div>

        <div>
          <label class="block text-sm text-gray-400 mb-1">Token Mint Address</label>
          <input
            type="text"
            id="tokenMint"
            class="input w-full"
            placeholder="Token mint address (from your launch)..."
          />
          <p class="text-xs text-gray-500 mt-1">
            Find this in "My Launches" on the launchpad, or in your launch confirmation.
          </p>
        </div>

        <button
          id="checkBalance"
          class="btn-primary w-full"
        >
          Check Balance
        </button>

        <div id="balanceResult" class="hidden p-4 rounded-lg border"></div>
      </div>
    </div>

    <!-- My Launches Quick Check -->
    <div class="card mb-8">
      <h2 class="text-xl font-bold mb-4">Your Recent Launches</h2>
      <p class="text-gray-400 text-sm mb-4">
        Enter your wallet to see all tokens you've launched.
      </p>

      <div class="space-y-4">
        <div>
          <label class="block text-sm text-gray-400 mb-1">Creator Wallet Address</label>
          <input
            type="text"
            id="creatorWallet"
            class="input w-full"
            placeholder="Your wallet address..."
          />
        </div>

        <button
          id="checkLaunches"
          class="btn bg-purple-600 hover:bg-purple-500 w-full"
        >
          Find My Launches
        </button>

        <div id="launchesResult" class="hidden"></div>
      </div>
    </div>

    <!-- Manual Token Import Guide -->
    <div class="card mb-8">
      <h2 class="text-xl font-bold mb-4">How to Add Tokens to Your Wallet</h2>

      <div class="space-y-6">
        <!-- Phantom -->
        <div class="border border-gray-700 rounded-lg p-4">
          <h3 class="font-bold text-purple-400 mb-2">Phantom Wallet</h3>
          <ol class="list-decimal list-inside text-sm text-gray-300 space-y-2">
            <li>Open Phantom and go to your token list</li>
            <li>Scroll to the bottom and click <span class="text-white font-mono bg-gray-800 px-1 rounded">Manage token list</span></li>
            <li>Click the <span class="text-white font-mono bg-gray-800 px-1 rounded">+</span> button</li>
            <li>Paste your token's <strong>Mint Address</strong></li>
            <li>Click <span class="text-white font-mono bg-gray-800 px-1 rounded">Add</span></li>
          </ol>
          <p class="text-xs text-yellow-400 mt-3">
            Note: Token-2022 tokens may require Phantom v24.9+ to display correctly.
          </p>
        </div>

        <!-- Solflare -->
        <div class="border border-gray-700 rounded-lg p-4">
          <h3 class="font-bold text-orange-400 mb-2">Solflare Wallet</h3>
          <ol class="list-decimal list-inside text-sm text-gray-300 space-y-2">
            <li>Open Solflare and go to Portfolio</li>
            <li>Click <span class="text-white font-mono bg-gray-800 px-1 rounded">+ Add New Asset</span></li>
            <li>Select <span class="text-white font-mono bg-gray-800 px-1 rounded">Add Token</span></li>
            <li>Paste your token's Mint Address</li>
            <li>Click <span class="text-white font-mono bg-gray-800 px-1 rounded">Add Token</span></li>
          </ol>
        </div>

        <!-- Backpack -->
        <div class="border border-gray-700 rounded-lg p-4">
          <h3 class="font-bold text-cyan-400 mb-2">Backpack Wallet</h3>
          <ol class="list-decimal list-inside text-sm text-gray-300 space-y-2">
            <li>Open Backpack and view your Solana tokens</li>
            <li>Click the settings gear icon</li>
            <li>Select <span class="text-white font-mono bg-gray-800 px-1 rounded">Add Token</span></li>
            <li>Paste the Mint Address and confirm</li>
          </ol>
        </div>
      </div>
    </div>

    <!-- Why Tokens Might Not Show -->
    <div class="card mb-8">
      <h2 class="text-xl font-bold mb-4">Why Your Tokens Might Not Show</h2>

      <div class="space-y-4">
        <div class="flex items-start gap-3">
          <span class="text-yellow-400 text-xl">1.</span>
          <div>
            <h4 class="font-bold">Token-2022 Program</h4>
            <p class="text-sm text-gray-400">
              8xM uses the new Token-2022 program for advanced features like enforced royalties.
              Some older wallet versions don't auto-detect Token-2022 tokens. Update your wallet
              or add the token manually using the mint address.
            </p>
          </div>
        </div>

        <div class="flex items-start gap-3">
          <span class="text-yellow-400 text-xl">2.</span>
          <div>
            <h4 class="font-bold">Missing Metadata</h4>
            <p class="text-sm text-gray-400">
              If your token shows as "Unknown Token" or just an address, the metadata
              may not have been uploaded. This is a display issue only - your tokens
              are still there and can be transferred/traded.
            </p>
          </div>
        </div>

        <div class="flex items-start gap-3">
          <span class="text-yellow-400 text-xl">3.</span>
          <div>
            <h4 class="font-bold">Wallet Cache</h4>
            <p class="text-sm text-gray-400">
              Wallets cache token data. Try refreshing your wallet, closing and reopening it,
              or clearing the cache in wallet settings.
            </p>
          </div>
        </div>

        <div class="flex items-start gap-3">
          <span class="text-yellow-400 text-xl">4.</span>
          <div>
            <h4 class="font-bold">Transaction Not Confirmed</h4>
            <p class="text-sm text-gray-400">
              If your launch transaction failed or wasn't confirmed, the tokens may not exist.
              Use the balance checker above to verify on-chain status.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Solscan Link -->
    <div class="card bg-gradient-to-r from-green-900/30 to-blue-900/30 border border-green-500/30">
      <h2 class="text-xl font-bold mb-2">View on Solscan (Always Works)</h2>
      <p class="text-gray-300 text-sm mb-4">
        Solscan always shows the true on-chain state. If tokens appear here, they exist!
      </p>

      <div class="flex flex-wrap gap-3">
        <a
          href="https://solscan.io/account/"
          target="_blank"
          class="btn bg-green-600 hover:bg-green-500"
          id="solscanWalletLink"
        >
          View Wallet on Solscan
        </a>
        <a
          href="https://solscan.io/token/"
          target="_blank"
          class="btn bg-blue-600 hover:bg-blue-500"
          id="solscanTokenLink"
        >
          View Token on Solscan
        </a>
      </div>
    </div>
  </div>

  <script>
    // Check balance functionality
    document.getElementById('checkBalance')?.addEventListener('click', async () => {
      const wallet = (document.getElementById('walletAddress') as HTMLInputElement)?.value;
      const mint = (document.getElementById('tokenMint') as HTMLInputElement)?.value;
      const resultDiv = document.getElementById('balanceResult');

      if (!wallet || !mint) {
        resultDiv!.className = 'p-4 rounded-lg border border-red-500 bg-red-900/30';
        resultDiv!.innerHTML = '<p class="text-red-400">Please enter both wallet and mint addresses.</p>';
        resultDiv!.classList.remove('hidden');
        return;
      }

      resultDiv!.className = 'p-4 rounded-lg border border-blue-500 bg-blue-900/30';
      resultDiv!.innerHTML = '<p class="text-blue-400">Checking balance...</p>';
      resultDiv!.classList.remove('hidden');

      try {
        // Use Helius or public RPC to check balance
        const response = await fetch('https://api.mainnet-beta.solana.com', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            jsonrpc: '2.0',
            id: 1,
            method: 'getTokenAccountsByOwner',
            params: [
              wallet,
              { mint },
              { encoding: 'jsonParsed' }
            ]
          })
        });

        const data = await response.json();

        if (data.result?.value?.length > 0) {
          const account = data.result.value[0];
          const balance = account.account.data.parsed.info.tokenAmount;

          resultDiv!.className = 'p-4 rounded-lg border border-green-500 bg-green-900/30';
          resultDiv!.innerHTML = `
            <p class="text-green-400 font-bold mb-2">Token Found!</p>
            <div class="text-sm space-y-1">
              <p><span class="text-gray-400">Balance:</span> <span class="text-white font-bold">${parseFloat(balance.uiAmountString).toLocaleString()}</span> tokens</p>
              <p><span class="text-gray-400">Token Account:</span> <span class="font-mono text-xs break-all">${account.pubkey}</span></p>
              <p><span class="text-gray-400">Decimals:</span> ${balance.decimals}</p>
            </div>
            <a href="https://solscan.io/account/${account.pubkey}" target="_blank" class="inline-block mt-3 text-green-400 hover:underline text-sm">
              View on Solscan →
            </a>
          `;
        } else {
          resultDiv!.className = 'p-4 rounded-lg border border-yellow-500 bg-yellow-900/30';
          resultDiv!.innerHTML = `
            <p class="text-yellow-400 font-bold mb-2">No Token Account Found</p>
            <p class="text-sm text-gray-300">
              This wallet doesn't have a token account for this mint.
              This could mean:
            </p>
            <ul class="list-disc list-inside text-sm text-gray-400 mt-2">
              <li>The token was never sent to this wallet</li>
              <li>The transaction failed or wasn't confirmed</li>
              <li>Wrong wallet or mint address entered</li>
            </ul>
            <a href="https://solscan.io/token/${mint}" target="_blank" class="inline-block mt-3 text-yellow-400 hover:underline text-sm">
              Check token on Solscan →
            </a>
          `;
        }
      } catch (error: any) {
        resultDiv!.className = 'p-4 rounded-lg border border-red-500 bg-red-900/30';
        resultDiv!.innerHTML = `<p class="text-red-400">Error: ${error.message}</p>`;
      }
    });

    // Check launches functionality
    document.getElementById('checkLaunches')?.addEventListener('click', async () => {
      const wallet = (document.getElementById('creatorWallet') as HTMLInputElement)?.value;
      const resultDiv = document.getElementById('launchesResult');

      if (!wallet) {
        resultDiv!.className = 'p-4 rounded-lg border border-red-500 bg-red-900/30';
        resultDiv!.innerHTML = '<p class="text-red-400">Please enter a wallet address.</p>';
        resultDiv!.classList.remove('hidden');
        return;
      }

      resultDiv!.className = 'p-4 rounded-lg border border-blue-500 bg-blue-900/30';
      resultDiv!.innerHTML = '<p class="text-blue-400">Looking up launches...</p>';
      resultDiv!.classList.remove('hidden');

      try {
        const response = await fetch(`/api/launchpad/create?wallet=${wallet}`);
        const data = await response.json();

        if (data.success && data.launches?.length > 0) {
          const launchesHtml = data.launches.map((launch: any) => `
            <div class="border border-gray-700 rounded-lg p-3 mb-2">
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                  ${launch.image_url ? `<img src="${launch.image_url}" class="w-8 h-8 rounded-full" />` : ''}
                  <div>
                    <p class="font-bold">${launch.name}</p>
                    <p class="text-xs text-purple-400">$${launch.symbol}</p>
                  </div>
                </div>
                <span class="px-2 py-0.5 rounded text-xs ${launch.phase === 'live' ? 'bg-green-600' : 'bg-gray-600'}">
                  ${launch.phase}
                </span>
              </div>
              <div class="text-xs space-y-1">
                <p><span class="text-gray-400">Mint:</span> <span class="font-mono break-all">${launch.token_mint || 'Not created'}</span></p>
                <p><span class="text-gray-400">Created:</span> ${new Date(launch.created_at).toLocaleString()}</p>
              </div>
              ${launch.token_mint ? `
                <div class="flex gap-2 mt-2">
                  <a href="https://solscan.io/token/${launch.token_mint}" target="_blank" class="text-xs text-green-400 hover:underline">Solscan</a>
                  <button class="text-xs text-purple-400 hover:underline copy-mint" data-mint="${launch.token_mint}">Copy Mint</button>
                </div>
              ` : ''}
            </div>
          `).join('');

          resultDiv!.className = 'mt-4';
          resultDiv!.innerHTML = `
            <p class="text-green-400 font-bold mb-3">Found ${data.launches.length} launch(es)</p>
            ${launchesHtml}
          `;

          // Add copy functionality
          resultDiv!.querySelectorAll('.copy-mint').forEach(btn => {
            btn.addEventListener('click', () => {
              navigator.clipboard.writeText((btn as HTMLElement).dataset.mint || '');
              (btn as HTMLElement).textContent = 'Copied!';
              setTimeout(() => { (btn as HTMLElement).textContent = 'Copy Mint'; }, 2000);
            });
          });
        } else {
          resultDiv!.className = 'p-4 rounded-lg border border-yellow-500 bg-yellow-900/30';
          resultDiv!.innerHTML = '<p class="text-yellow-400">No launches found for this wallet.</p>';
        }
      } catch (error: any) {
        resultDiv!.className = 'p-4 rounded-lg border border-red-500 bg-red-900/30';
        resultDiv!.innerHTML = `<p class="text-red-400">Error: ${error.message}</p>`;
      }
    });

    // Update Solscan links when wallet/token entered
    document.getElementById('walletAddress')?.addEventListener('input', (e) => {
      const link = document.getElementById('solscanWalletLink');
      if (link) link.setAttribute('href', `https://solscan.io/account/${(e.target as HTMLInputElement).value}`);
    });

    document.getElementById('tokenMint')?.addEventListener('input', (e) => {
      const link = document.getElementById('solscanTokenLink');
      if (link) link.setAttribute('href', `https://solscan.io/token/${(e.target as HTMLInputElement).value}`);
    });
  </script>
</Layout>
